alias l='ls -lah'
alias ll='ls -lah'
alias py='python3'
alias vi='vim'

if [ -f "$HOME/.targetip" ]; then
    export targetip="$(cat "$HOME/.targetip")"
fi

targetip() {
    if [ -f "$HOME/.targetip" ]; then
        cat "$HOME/.targetip"
    fi
}

vpnfilemv() {
    mkdir -p ~/vpn
    mv ~/Downloads/*.ovpn ~/vpn/ 2>/dev/null || echo "No .ovpn files found in ~/Downloads"
    echo "Moved .ovpn files to ~/vpn"
}

vpns() {
    l ~/vpn
}

htbip() {
    ip a | grep -oP '10\.10\.\d+\.\d+' | head -n1
}

connvpn() {
    sudo -l >/dev/null

    local vpn_dir="$HOME/vpn"
    local vpn_files=("$vpn_dir"/*.ovpn)
    
    if [ ! -d "$vpn_dir" ] || [ ${#vpn_files[@]} -eq 0 ] || [ ! -f "${vpn_files[0]}" ]; then
        echo "No .ovpn files found in ~/vpn"
        echo "Usage: connvpn <config_file.ovpn> (optional)"
        return 1
    fi

    if [ -z "$1" ]; then
        echo "Available VPN files:"
        local i=1
        for file in "${vpn_files[@]}"; do
            if [ -f "$file" ]; then
                echo "  $i) $(basename "$file")"
                ((i++))
            fi
        done
        
        echo -n "Select VPN file (1-$((i-1))): "
        read -r choice
        
        if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt $((i-1)) ]; then
            echo "Invalid selection"
            return 1
        fi
        
        selected_file="${vpn_files[$((choice-1))]}"
    else
        selected_file="$1"
    fi
    
    if [ ! -f "$selected_file" ]; then
        echo "VPN file not found: $selected_file"
        return 1
    fi

    echo "Connecting to $(basename "$selected_file")..."
    sudo nohup openvpn --config "$selected_file" </dev/null >/dev/null 2>&1 &

    htbip
}

stopvpn() {
    sudo killall openvpn

    htbip > /dev/null
}

newmachine() {
    local dirname=${1:-ctf_env}

    mkdir -p "$dirname"/{source_code,data,scripts}

    touch "$dirname"/{tmp,credentials}

    touch "$(pwd)/$dirname/scripts/exploit.py"

    echo "[*] Environment created at $(pwd)/$dirname"

    python -m venv "$(pwd)/$dirname/scripts/venv"

    echo "[*] Python environment created at $(pwd)/$dirname/scripts"
    
    source "$(pwd)/$dirname/scripts/venv/bin/activate"

    restorehosts

    echo "[*] Restored hosts"

    cd "$dirname"

    echo "[*] Changed to directory: $(pwd)"
}

batdiff() {
    git diff --name-only --relative --diff-filter=d -z $1 | xargs --null bat --diff
}

notify() {
    nohup bash -c 'timeSent=$(date +"%H:%M");sleep "$(($1*60))"; notify-send -a "$timeSent - $(date +"%H:%M")" -u critical " $2"' dummy "$1" "$2" >/dev/null 2>&1 & disown
}

addhost() {
    if [ $# -eq 2 ]; then
        ip=$1
        domain=$2
    elif [ $# -eq 1 ] && [ -n "$targetip" ]; then
        ip=$targetip
        domain=$1
    else
        echo "Usage: addhost <IP> <domain>"
        echo "Or set targetip and run: addhost <domain>"
        return 1
    fi

    echo "$ip $domain" | sudo tee -a /etc/hosts > /dev/null
    cat /etc/hosts
}

restorehosts() {
    echo "127.0.0.1        localhost" | sudo tee /etc/hosts > /dev/null
    echo "::1              localhost" | sudo tee -a /etc/hosts > /dev/null
    cat /etc/hosts
}

settargetip() {
    echo "$1" > ~/.targetip
    export targetip="$1"
}

validate_sha256() {
    local expected="$1"
    local file="$2"

    if [[ -z "$expected" || -z "$file" ]]; then
        echo "Usage: validate_sha256 <expected_sha256> <file>"
        return 1
    fi

    if [[ ! -f "$file" ]]; then
        echo "Error: File '$file' not found."
        return 1
    fi

    local actual
    actual=$(sha256sum "$file" | awk '{print $1}')

    if [[ "$expected" == "$actual" ]]; then
        echo "SHA256 matches!"
        return 0
    else
        echo "SHA256 mismatch!"
        echo "Expected: $expected"
        echo "Actual:   $actual"
        return 1
    fi
}

tofile() {
    if [[ -z "$1" ]]; then
        echo "Usage: tofile <filename>"
        return 1
    fi
    
    cat > "$1"
}
